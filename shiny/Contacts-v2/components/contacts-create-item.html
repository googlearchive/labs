<link href="../../../../polymer-elements/polymer-flex-layout/polymer-flex-layout.html" rel="import">
<link href="../../../../polymer-elements/polymer-selector/polymer-selector.html" rel="import">
<link href="../../../../polymer-ui-elements/polymer-ui-icon-button/polymer-ui-icon-button.html" rel="import">
<link href="../../../../polymer-ui-elements/polymer-ui-menu-item/polymer-ui-menu-item.html" rel="import">
<link href="../../../../polymer-ui-elements/polymer-ui-overlay/polymer-ui-overlay.html" rel="import">
<polymer-element name="contacts-create-item" attributes="autofocus icon activeIcon label value selectedType active overlayActive" on-focus="focusAction" on-blur="blurAction" on-mouseover="focusAction" on-mouseout="blurAction">
	<template>
		<style>
			/* @polyfill @host */
			:host {
				padding: 0 20px;
				border-color: rgba(0, 0, 0, 0.14902);
				border-width: 0 1px 1px;
				border-style: solid;
			}
			input {
				margin-left: 20px;
				border: none;
				font-size: 18px;
				font-family: 'Helvetica Neue Medium', HelveticaNeue-Medium, Helvetica, sans-serif;
				box-sizing: border-box;
				height: 60px;
			}
			input:focus {
				outline: none;
			}
			.hidden {
				/* FIXME: outside should win */
				display: none !important;
			}
			#overlay {
				left: 0;
				padding: 10px;
			}
			#overlay input {
				margin-left: 0px;
				height: auto;
			}
			#overlay polymer-ui-menu-item {
				font-size: 18px;
				height: 61px;
				font-family: 'Helvetica Neue Medium', HelveticaNeue-Medium, Helvetica, sans-serif;
				padding: 10px 20px;
				border-color: rgba(0, 0, 0, 0.14902);
				border-width: 0 1px 1px;
				border-style: solid;
			}
			/* FIXME: Safari drops the whole rule if it doesn't recognize the selector. */
			#overlay content::-webkit-distributed(polymer-ui-menu-item) {
				font-size: 18px;
				height: 61px;
				font-family: 'Helvetica Neue Medium', HelveticaNeue-Medium, Helvetica, sans-serif;
				padding: 10px 20px;
				border-color: rgba(0, 0, 0, 0.14902);
				border-width: 0 1px 1px;
				border-style: solid;
			}
		</style>
		<polymer-flex-layout align="center"></polymer-flex-layout>
		<polymer-ui-icon-button icon="{{icon}}" class="{{hidden: active || overlayActive || value || selectedType !== -1}}"></polymer-ui-icon-button>
		<polymer-ui-icon-button id="activeIcon" icon="{{activeIcon}}" class="{{hidden: !value && selectedType === -1 && !active && !overlayActive}}" on-tap="overlayAction"></polymer-ui-icon-button>
		<div flex>
			<input id="input" value="{{value}}" placeholder="{{label}}" autofocus?="{{autofocus}}">
		</div>
		<polymer-ui-icon-button icon="close" class="{{hidden: !active && !overlayActive}}" on-tap="cancelAction"></polymer-ui-icon-button>
		<polymer-ui-overlay id="overlay" active="{{overlayActive}}" modal backdrop on-polymer-overlay-open="overlayOpenAction">
			<polymer-ui-menu-item icon="shrink" on-tap="overlayShrinkAction">
				<input id="overlayInput" value="{{value}}" placeholder="{{label}}">
			</polymer-ui-menu-item>
			<polymer-selector selected="{{selectedType}}" on-polymer-activate="overlaySelectAction">
				<content></content>
			</polymer-selector>
		</polymer-ui-overlay>
	</template>
	<script>
		Polymer('contacts-create-item', {
			autofocus: false,
			active: false,
			overlayActive: false,
			icon: 'plus',
			selectedType: -1,
			enteredDocument: function() {
				this.$.overlay.style.width = (window.innerWidth - 20) + 'px';
				this.$.overlay.style.top = ((window.innerHeight - this.$.overlay.getBoundingClientRect().height) / 2) + 'px';
			},
			overlayOpenAction: function() {
				if (this.overlayActive) {
					setTimeout(function() {
						this.$.overlayInput.focus();
					}.bind(this), 10);
				}
			},
			focusAction: function() {
				this.active = true;
			},
			blurAction: function() {
				// Async so if the tap events from the buttons have a chance to fire.
				this.async(function() {
					this.active = false;
					if (!this.value) {
						this.cancelAction();
					}
				}, null, 100);
			},
			cancelAction: function() {
				this.value = '';
				this.selectedType = -1;
				this.fire('contacts-create-item-cancel');
			},
			overlayAction: function() {
				this.$.overlay.toggle();
			},
			overlaySelectAction: function(e, detail, sender) {
				this.activeIcon = detail.item.icon;
				this.$.overlay.toggle();
			},
			overlayShrinkAction: function(e, detail, sender) {
				var src = window.ShadowDOMPolyfill ? wrap(e.srcElement) : e.srcElement;
				if (src !== this.$.overlayInput) {
					this.$.overlay.toggle();
				}
			},
			focus: function() {
				this.$.input.focus();
			}
		});
		</script>
</polymer-element>
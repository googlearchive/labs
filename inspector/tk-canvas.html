<!--
Copyright 2013 The Toolkitchen Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<element name="tk-canvas" on-pointerup="up" on-trackstart="trackStart" on-track="track" on-trackend="trackEnd">
  <template>
    <style>
      @host {
        * {
          outline: none;
        }
      }
      #eventer {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-image: url(assets/dot.png);
      }
    </style>
    <div id="eventer" touch-action="none">
      <content></content>
    </div>
  </template>

  <script>
    Toolkit.register(this, {
      grid: 16,
      snap: function(inX, inY) {
        return {
          x: Math.round(inX / this.grid) * this.grid,
          y: Math.round(inY / this.grid) * this.grid
        };
      },
      trackStart: function(event) {
        var elt = event.target;
        while (elt && elt.parentNode && elt.parentNode !== this) {
          elt = elt.parentNode; 
        }
        if (elt === this) {
          elt = null;
        }
        this.tracking = elt;
        if (elt) {
          this.startPoint = {x:elt.offsetLeft, y: elt.offsetTop};
        }
      },
      track: function(event) {
        if (this.tracking) {
          var p = {
            x: this.startPoint.x + event.dx, 
            y: this.startPoint.y + event.dy
          };
          p = this.snap(p.x, p.y);
          this.tracking.style.left = p.x + 'px';
          this.tracking.style.top = p.y + 'px'; 
        }
      },
      trackEnd: function(event) {
        this.tracking = null;
      }
    });
  </script>

</element>